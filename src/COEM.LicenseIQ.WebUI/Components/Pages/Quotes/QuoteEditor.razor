@page "/quotes/new"
@using COEM.LicenseIQ.Domain.Entities.Quotes
@using COEM.LicenseIQ.Domain.Entities
@using COEM.LicenseIQ.Application.Common.Models
@using COEM.LicenseIQ.Application.Common.Interfaces.Services
@using COEM.LicenseIQ.Infrastructure.Services
@inject IPriceIngestionService PriceService
@inject QuoteExportService ExportService
@inject IJSRuntime JS
@implements IDisposable
@rendermode InteractiveServer

<div class="container-fluid pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-calculator-fill text-primary"></i> Cotizador Zenith</h2>
        <button class="btn btn-success fw-bold" @onclick="DownloadExcel" disabled="@(!currentQuote.Items.Any())">
            <i class="bi bi-file-earmark-excel-fill"></i> Exportar Excel
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body bg-light">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold text-primary">1. País / Lista</label>
                    <InputSelect class="form-select border-primary" @bind-Value="selectedCountryId">
                        <option value="0">Seleccione...</option>
                        @foreach (var c in availableCountries)
                        {
                            <option value="@c.CountryID">@c.Name (@c.IsoCode)</option>
                        }
                    </InputSelect>
                </div>

                <div class="col-md-5">
                    <label class="form-label fw-bold">2. Cliente</label>
                    <input type="text" class="form-control" @bind="currentQuote.CustomerName" placeholder="Empresa Cliente S.A.S..." />
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">3. Proyecto</label>
                    <input type="text" class="form-control" @bind="currentQuote.ProjectName" placeholder="Migración Nube..." />
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">4. Moneda</label>
                    <select class="form-select" @bind="currentQuote.Currency">
                        <option>USD</option>
                        <option>COP</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold">
                    <i class="bi bi-search"></i> Catálogo
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Escribe para buscar (ej: Windows)..."
                               @bind="searchTerm"
                               @oninput="OnSearchInput" />
                    </div>

                    @if (isSearching)
                    {
                        <div class="text-center py-3"><span class="spinner-border text-primary"></span></div>
                    }
                    else
                    {
                        <div class="list-group overflow-auto" style="max-height: 500px;">
                            @foreach (var prod in searchResults)
                            {
                                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                        @onclick="() => AddToQuote(prod)">
                                    <div style="width: 70%">
                                        <div class="fw-bold small text-truncate">@prod.ProductName</div>
                                        <div class="text-muted" style="font-size: 0.7rem">@prod.SkuId | @prod.Segment</div>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">@prod.UnitPrice.ToString("N2")</span>
                                </button>
                            }
                            @if (searchResults.Count == 0 && !string.IsNullOrEmpty(searchTerm) && searchTerm.Length > 2)
                            {
                                <div class="text-center text-muted mt-3 small">No hay resultados. Verifique el País seleccionado.</div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold d-flex justify-content-between">
                    <span>Items Seleccionados (@currentQuote.Items.Count)</span>
                    <span class="text-success fs-5">Total: @currentQuote.Items.Sum(i => i.TotalLine).ToString("C2")</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light small">
                            <tr>
                                <th style="width:30%">Producto</th>
                                <th style="width:10%">Costo</th>
                                <th style="width:10%">Margen %</th>
                                <th style="width:10%">Precio Venta</th>
                                <th style="width:10%">Cant.</th>
                                <th style="width:15%">Total</th>
                                <th style="width:5%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in currentQuote.Items)
                            {
                                <tr>
                                    <td class="small">
                                        <div class="text-truncate" style="max-width: 200px;" title="@item.ProductName">@item.ProductName</div>
                                        <small class="text-muted">@item.TermDuration</small>
                                    </td>
                                    <td class="text-end small">@item.UnitCost.ToString("N2")</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm"
                                               value="@item.MarginPercent"
                                               @onchange="@(e => UpdateMargin(item, e.Value))" step="1" />
                                    </td>
                                    <td class="text-end fw-bold text-primary">@item.UnitPrice.ToString("N2")</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm"
                                               value="@item.Quantity"
                                               @onchange="@(e => UpdateQuantity(item, e.Value))" min="1" />
                                    </td>
                                    <td class="text-end fw-bold">@item.TotalLine.ToString("N2")</td>
                                    <td>
                                        <button class="btn btn-link text-danger p-0" @onclick="() => RemoveItem(item)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.downloadFileFromStream = async (fileName, contentStreamReference) => {
        const arrayBuffer = await contentStreamReference.arrayBuffer();
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);
        const anchorElement = document.createElement('a');
        anchorElement.href = url;
        anchorElement.download = fileName ?? '';
        anchorElement.click();
        anchorElement.remove();
        URL.revokeObjectURL(url);
    }
</script>

@code {
    private Quote currentQuote = new() { CreatedBy = Guid.NewGuid() }; // ID temporal de usuario
    private List<Country> availableCountries = new();
    private int selectedCountryId = 0;

    // Búsqueda
    private List<ProductExplorerDto> searchResults = new();
    private string searchTerm = "";
    private string? errorMessage;
    private bool isSearching = false;

    // Timer para Debounce (Evita crash por escribir rápido)
    private System.Timers.Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            availableCountries = await PriceService.GetActiveCountriesAsync();
            if (availableCountries.Any()) selectedCountryId = availableCountries.First().CountryID;
        }
        catch (Exception ex)
        {
            errorMessage = "Error cargando países: " + ex.Message;
        }

        // Configurar timer: espera 500ms después de dejar de escribir
        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (sender, e) => await InvokeAsync(PerformSearch);
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";

        // Reiniciamos el reloj cada vez que escribes una letra
        _debounceTimer?.Stop();
        if (searchTerm.Length >= 3)
        {
            isSearching = true; // Mostrar spinner
            _debounceTimer?.Start();
        }
        else
        {
            searchResults.Clear();
            isSearching = false;
        }
    }

    private async Task PerformSearch()
    {
        try
        {
            if (selectedCountryId == 0) return;

            // Busca usando el ID REAL seleccionado, no uno inventado
            searchResults = await PriceService.SearchProductsAsync(selectedCountryId, DateTime.Today, searchTerm);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error en búsqueda: {ex.Message}";
        }
        finally
        {
            isSearching = false;
            StateHasChanged(); // Actualizar UI
        }
    }

    private void AddToQuote(ProductExplorerDto product)
    {
        var item = new QuoteItem
        {
            SkuId = product.SkuId,
            ProductName = product.ProductName,
            Segment = product.Segment,
            UnitCost = product.UnitPrice,
            MarginPercent = 10,
            Quantity = 1,
            TermDuration = "P1Y", // Default
            BillingPlan = "Monthly"
        };
        RecalculateItem(item);
        currentQuote.Items.Add(item);
        searchTerm = ""; // Limpiar buscador
        searchResults.Clear();
    }

    private void UpdateMargin(QuoteItem item, object value)
    {
        if (decimal.TryParse(value.ToString(), out decimal margin))
        {
            item.MarginPercent = margin;
            RecalculateItem(item);
        }
    }

    private void UpdateQuantity(QuoteItem item, object value)
    {
        if (int.TryParse(value.ToString(), out int qty))
        {
            item.Quantity = qty;
        }
    }

    private void RecalculateItem(QuoteItem item)
    {
        item.UnitPrice = item.UnitCost * (1 + (item.MarginPercent / 100));
    }

    private void RemoveItem(QuoteItem item)
    {
        currentQuote.Items.Remove(item);
    }

    private async Task DownloadExcel()
    {
        try
        {
            if (string.IsNullOrEmpty(currentQuote.CustomerName)) currentQuote.CustomerName = "Cliente_General";

            var excelBytes = ExportService.GenerateExcel(currentQuote);
            using var stream = new MemoryStream(excelBytes);
            using var streamRef = new DotNetStreamReference(stream);

            await JS.InvokeVoidAsync("downloadFileFromStream", $"Cotizacion_{currentQuote.CustomerName}.xlsx", streamRef);
        }
        catch (Exception ex)
        {
            errorMessage = "Error exportando: " + ex.Message;
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}